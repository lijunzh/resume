#!/usr/bin/env bash
#
# Pre-commit hook for LaTeX resume project
# Runs quality checks before allowing commits
#

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "Makefile" ] || [ ! -f "resume.tex" ]; then
    echo "âŒ Error: Not in LaTeX resume project root directory"
    exit 1
fi

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check required dependencies
echo "ğŸ“‹ Checking dependencies..."
if ! command_exists make; then
    echo "âŒ Error: make is required but not installed"
    exit 1
fi

if ! command_exists latexmk; then
    echo "âŒ Error: latexmk is required but not installed"
    exit 1
fi

if ! command_exists xelatex; then
    echo "âŒ Error: xelatex is required but not installed"
    exit 1
fi

echo "âœ… Dependencies check passed"

# Run linting
echo "ğŸ§¹ Running lint checks..."
if ! make lint; then
    echo "âŒ Error: Lint checks failed"
    echo "ğŸ’¡ Fix the issues above before committing"
    exit 1
fi

echo "âœ… Lint checks passed"

# Try to build all documents
echo "ğŸ”¨ Testing build process..."
if ! make clean >/dev/null 2>&1; then
    echo "âŒ Error: Failed to clean build directory"
    exit 1
fi

if ! make all >/dev/null 2>&1; then
    echo "âŒ Error: Build process failed"
    echo "ğŸ’¡ Check build logs in build/*.log"
    exit 1
fi

echo "âœ… Build test passed"

# Validate generated PDFs
echo "ğŸ“„ Validating PDFs..."
if ! make validate >/dev/null 2>&1; then
    echo "âŒ Error: PDF validation failed"
    exit 1
fi

echo "âœ… PDF validation passed"

# Check for large files
echo "ğŸ“ Checking file sizes..."
large_files=$(find build -name "*.pdf" -size +5M 2>/dev/null || true)
if [ -n "$large_files" ]; then
    echo "âš ï¸  Warning: Large PDF files detected:"
    echo "$large_files"
    echo "ğŸ’¡ Consider optimizing images or content"
fi

# Check git status
staged_files=$(git diff --cached --name-only)
if echo "$staged_files" | grep -q "\.tex$\|\.bib$\|\.cls$"; then
    echo "ğŸ“ LaTeX files detected in commit"
    
    # Check for TODO/FIXME in staged files
    if git diff --cached | grep -E "TODO|FIXME|XXX" >/dev/null; then
        echo "âš ï¸  Warning: TODO/FIXME comments found in staged changes"
        echo "ğŸ’¡ Consider resolving these before committing"
    fi
fi

echo ""
echo "ğŸ‰ All pre-commit checks passed!"
echo "âœ¨ Ready to commit changes"
echo ""

exit 0
